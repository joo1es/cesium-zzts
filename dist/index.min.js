!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("cesium")):"function"==typeof define&&define.amd?define(["cesium"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).CesiumZZTS=t(e.Cesium)}(this,(function(e){"use strict";function t(t){var s=e.Rectangle.northwest(t),a=e.Rectangle.northeast(t),i=e.Rectangle.southeast(t),n=e.Rectangle.southwest(t);return new e.PolygonHierarchy([e.Cartesian3.fromRadians(s.longitude,s.latitude),e.Cartesian3.fromRadians(a.longitude,a.latitude),e.Cartesian3.fromRadians(i.longitude,i.latitude),e.Cartesian3.fromRadians(n.longitude,n.latitude)])}return class{constructor(t,s){this.end=!1,this.delay=1e3,this.scale=5,this.layers=[],this.viewer=t,this.options=s,this.getCapabilities(),this.removeEvent=this.viewer.camera.moveEnd.addEventListener((()=>this.getElements())),this.dataSource=new e.CustomDataSource(String(Math.random())),t.dataSources.add(this.dataSource)}getCapabilities(){const e=new URL(this.options.url);e.searchParams.append("REQUEST","GetCapabilities"),e.searchParams.append("SERVICE","ZZTS"),e.searchParams.append("LAYER",this.options.layerName);for(const t in this.options.customParameters)e.searchParams.append(t,this.options.customParameters[t]);return fetch(e).then((e=>e.json())).then((e=>{var t,s;this.capabilities=e,null===(s=(t=this.options).onLoad)||void 0===s||s.call(t,e),this.getElements()}))}getElements(){if(this.end)return;this.controller&&this.controller.abort(),this.controller=new AbortController;const e=this.controller.signal,t=new URL(this.options.url+"/elements");t.searchParams.append("SRS","EPSG:4326"),t.searchParams.append("SERVICE","ZZTS"),t.searchParams.append("LAYER",this.options.layerName);const s=this.getCameraBounds();s&&t.searchParams.append("BBOX",`${s.west},${s.north},${s.east},${s.south}`);const a=this.viewer.container.clientHeight,i=this.viewer.container.clientWidth;t.searchParams.append("SCALE",String(this.getScale())),t.searchParams.append("HEIGHT",String(a)),t.searchParams.append("WIDTH",String(i));for(const e in this.options.customParameters)t.searchParams.append(e,this.options.customParameters[e]);return fetch(t,{signal:e}).then((e=>e.json())).then((e=>{var t,s;const a=e.elements||[];if(a){this.currentElements=a,null===(s=(t=this.options).onGetZoom)||void 0===s||s.call(t,e.zoom);for(const e of a){if(!e.id)return;this.loadImage(e.id,e)}for(const e in this.layers){if(!a.find((t=>t.id===e))){const t=this.layers[e];delete this.layers[e],setTimeout((()=>{this.dataSource.entities.remove(t)}),this.delay)}}}})).catch((e=>{}))}getCameraBounds(){const t=this.viewer.camera.computeViewRectangle();if(t){return{west:e.Math.toDegrees(t.west),south:e.Math.toDegrees(t.south),east:e.Math.toDegrees(t.east),north:e.Math.toDegrees(t.north)}}}getScale(){const t=this.viewer.scene.camera.positionWC,s=this.viewer.scene.globe.ellipsoid.scaleToGeodeticSurface(t);return e.Cartesian3.magnitude(e.Cartesian3.subtract(t,s,new e.Cartesian3))*this.scale}loadImage(s,a,i=0){if(3===i)return;const n=new Image;n.src=a.url,n.onload=()=>{if(this.layers[s])return;if(this.end)return;const i=e.Rectangle.fromDegrees(a.extent.xmin,a.extent.ymin,a.extent.xmax,a.extent.ymax),n=this.dataSource.entities.add({id:s,name:s,polygon:{hierarchy:t(i),zIndex:this.options.index,material:new e.ImageMaterialProperty({image:a.url})}});this.layers[s]||(this.layers[s]=n)},n.onerror=()=>{setTimeout((()=>this.loadImage(s,a,i+1)),3e3)}}fly(e=3){var t;(null===(t=this.capabilities)||void 0===t?void 0:t.extent)&&this.viewer.camera.flyTo({destination:this.getRectangle(),duration:e})}getRectangle(){var t;if(!(null===(t=this.capabilities)||void 0===t?void 0:t.extent))return;const s=this.capabilities.extent;return e.Rectangle.fromDegrees(s.xmin,s.ymin,s.xmax,s.ymax)}destory(){this.end=!0,this.layers.forEach((e=>{this.dataSource.entities.remove(e)})),this.layers=[],this.removeEvent(),this.viewer.dataSources.remove(this.dataSource)}setIndex(e){this.options.index=e,this.getElements()}updateSort(e){!function(e){if(0===e.length)return;const t=[...e];t.forEach((e=>e.viewer.dataSources.remove(e.dataSource))),t.sort(((e,t)=>e.options.index-t.options.index)),t.forEach((e=>e.viewer.dataSources.add(e.dataSource)))}(e)}}}));
