!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("cesium")):"function"==typeof define&&define.amd?define(["cesium"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).CesiumZZTS=t(e.Cesium)}(this,(function(e){"use strict";return class{constructor(t,s){this.end=!1,this.layers=[],this.viewer=t,this.options=s,this.getCapabilities(),this.getElements(),this.viewer.camera.changed.addEventListener((()=>this.getElements())),this.viewer.screenSpaceEventHandler.setInputAction(this.handleClick,e.ScreenSpaceEventType.LEFT_CLICK)}handleClick(t){var s,i;const n=this.viewer.scene.globe.pick(this.viewer.camera.getPickRay(t.position),this.viewer.scene);if(e.defined(n)){const t=e.Cartographic.fromCartesian(n),r=e.Math.toDegrees(t.longitude),a=e.Math.toDegrees(t.latitude);e.Rectangle.contains(this.getRectangle(),t)&&(null===(i=(s=this.options).onClick)||void 0===i||i.call(s,{mapPoint:{longitude:r,latitude:a},options:this.options}),console.log("在图形内"))}}getCapabilities(){const e=new URL(this.options.url);e.searchParams.append("REQUEST","GetCapabilities"),e.searchParams.append("SERVICE","ZZTS"),e.searchParams.append("LAYER",this.options.layerName);for(const t in this.options.customParameters)e.searchParams.append(t,this.options.customParameters[t]);return fetch(e).then((e=>e.json())).then((e=>{var t,s;this.capabilities=e,null===(s=(t=this.options).onLoad)||void 0===s||s.call(t,e)}))}getElements(){if(this.end)return;this.controller&&this.controller.abort(),this.controller=new AbortController;const e=this.controller.signal,t=new URL(this.options.url+"/elements");t.searchParams.append("SRS","EPSG:4326"),t.searchParams.append("SERVICE","ZZTS"),t.searchParams.append("LAYER",this.options.layerName);const s=this.getCameraBounds();s&&t.searchParams.append("BBOX",`${s.west},${s.north},${s.east},${s.south}`);const i=this.viewer.container.clientHeight,n=this.viewer.container.clientWidth;t.searchParams.append("SCALE",String(this.getScale())),t.searchParams.append("HEIGHT",String(i)),t.searchParams.append("WIDTH",String(n));for(const e in this.options.customParameters)t.searchParams.append(e,this.options.customParameters[e]);return fetch(t,{signal:e}).then((e=>e.json())).then((e=>{var t,s;const i=e.elements||[];if(i){this.currentElements=i,null===(s=(t=this.options).onGetZoom)||void 0===s||s.call(t,e.zoom);for(const e of i){if(!e.id)return;this.loadImage(e.id,e)}for(const t in this.layers){if(!e.elements.find((e=>e.id===t))){const e=this.layers[t];delete this.layers[t],setTimeout((()=>{this.viewer.scene.imageryLayers.remove(e),e.destroy()}),800)}}}})).catch((e=>{}))}getCameraBounds(){const t=this.viewer.camera.computeViewRectangle();if(t){return{west:e.Math.toDegrees(t.west),south:e.Math.toDegrees(t.south),east:e.Math.toDegrees(t.east),north:e.Math.toDegrees(t.north)}}}getScale(){const t=this.viewer.scene.camera.positionWC,s=this.viewer.scene.globe.ellipsoid.scaleToGeodeticSurface(t);return 10*e.Cartesian3.magnitude(e.Cartesian3.subtract(t,s,new e.Cartesian3))}loadImage(t,s,i=0){if(3===i)return;if(!this.currentElements.find((e=>e.id===s.id)))return;const n=new Image;n.src=s.url,n.onload=()=>{if(this.layers[t])return;if(this.end)return;if(!this.currentElements.find((e=>e.id===s.id)))return;const i=e.Rectangle.fromDegrees(s.extent.xmin,s.extent.ymin,s.extent.xmax,s.extent.ymax),n=this.viewer.scene.imageryLayers.addImageryProvider(new e.SingleTileImageryProvider({url:s.url,rectangle:i}),this.options.index);this.layers[t]||(this.layers[t]=n)},n.onerror=()=>{setTimeout((()=>this.loadImage(t,s,i+1)),1e3)}}fly(e=3){this.capabilities.extent&&this.viewer.camera.flyTo({destination:this.getRectangle(),duration:e})}getRectangle(){if(!this.capabilities.extent)return;const t=this.capabilities.extent;return e.Rectangle.fromDegrees(t.xmin,t.ymin,t.xmax,t.ymax)}destory(){this.end=!0,this.layers.forEach((e=>{this.viewer.scene.imageryLayers.remove(e),e.destroy()})),this.layers=[],this.entity&&this.viewer.entities.remove(this.entity)}}}));
